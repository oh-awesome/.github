name: Mirror and Update README

on:
  schedule:
    - cron: "0 1 * * *" # Run daily at 1 AM
  workflow_dispatch:

jobs:
  mirror-and-update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - src_user: "openharmony-tpc"
            account_type: "org"
            static_list: "flutter_packages" # Sync specific repo
          - src_user: "OpenHarmonyPCDeveloper"
            account_type: "org"
            static_list: "DevBox"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Mirror Gitcode to GitHub
        uses: Yikun/hub-mirror-action@master
        with:
          src: gitcode/${{ matrix.src_user }}
          dst: github/oh-awesome
          dst_key: ${{ secrets.SSH_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITHUB_TOKEN }}
          src_token: ${{ secrets.GITCODE_TOKEN }}
          account_type: ${{ matrix.account_type }}
          src_user: ${{ matrix.src_user }}
          dst_user: "oh-awesome" # Destination Org
          force_update: true
          static_list: ${{ matrix.static_list }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate README
        env:
          GITHUB_USERNAME: "oh-awesome" # Fetch repos from this Org
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_API_BASE: ${{ secrets.LLM_API_BASE }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
        run: python .github/scripts/generate_readme.py

      - name: Commit and Push README
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md repo_data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update README and cache with mirrored repositories"
            git push
          fi

      - name: Feishu Notification
        if: always()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
          else
            EMOJI="❌"
          fi

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$EMOJI Gitcode Mirror & README Update Finished\nStatus: $STATUS\nRepo: ${{ github.repository }}\"}}" \
            $FEISHU_WEBHOOK
